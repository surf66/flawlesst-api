# Accessibility Scanner

A containerized accessibility scanner using Playwright and axe-core that runs on AWS Fargate.

## Overview

This scanner performs comprehensive accessibility audits on web pages using:
- **Playwright**: For browser automation and page rendering
- **axe-core**: For accessibility testing against WCAG guidelines
- **Supabase**: For storing scan results and status updates

## Environment Variables

The scanner expects the following environment variables:

### Required
- `TARGET_URL`: The URL to scan for accessibility violations
- `CUSTOMER_ID`: Customer identifier for tracking
- `SUPABASE_URL`: Supabase project URL
- `SUPABASE_SERVICE_KEY`: Supabase service role key

### Optional
- `SCAN_ID`: Unique identifier for the scan (generated by Lambda)
- `NODE_ENV`: Environment (defaults to production)

## Usage

### Local Development

1. Install dependencies:
```bash
npm install
```

2. Build the TypeScript code:
```bash
npm run build
```

3. Run with environment variables:
```bash
export TARGET_URL="https://example.com"
export CUSTOMER_ID="test-customer"
export SUPABASE_URL="your-supabase-url"
export SUPABASE_SERVICE_KEY="your-service-key"
npm start
```

### Docker Deployment

1. Build the Docker image:
```bash
docker build -t accessibility-scanner .
```

2. Run with environment variables:
```bash
docker run --rm \
  -e TARGET_URL="https://example.com" \
  -e CUSTOMER_ID="test-customer" \
  -e SUPABASE_URL="your-supabase-url" \
  -e SUPABASE_SERVICE_KEY="your-service-key" \
  accessibility-scanner
```

## Scan Process

1. **Initialization**: Sets up browser and Supabase client
2. **Status Update**: Updates scan status to 'running'
3. **Page Load**: Navigates to target URL with proper viewport
4. **Accessibility Scan**: Injects axe-core and runs violations check
5. **Results Storage**: Saves detailed violation data to Supabase
6. **Cleanup**: Closes browser and updates final status

## Output

The scanner outputs:
- Console logs with scan progress and summary
- Detailed JSON violations data
- Final status update in Supabase database

## Database Schema

Results are stored in the `accessibility_scans` table:

```sql
CREATE TABLE accessibility_scans (
    id UUID PRIMARY KEY,
    customer_id UUID NOT NULL,
    target_url TEXT NOT NULL,
    scan_status VARCHAR(20) NOT NULL,
    violations JSONB NOT NULL DEFAULT '[]',
    violation_count INTEGER NOT NULL DEFAULT 0,
    scan_duration_ms INTEGER,
    error_message TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    completed_at TIMESTAMP WITH TIME ZONE
);
```

## Error Handling

The scanner handles various error scenarios:
- Network connectivity issues
- Page load failures
- JavaScript errors on target pages
- Database connection issues
- Invalid URLs

All errors are logged and stored in the database with appropriate status updates.

## Performance Considerations

- Scan timeout: 30 seconds for page load
- Memory usage: Configured for 2GB container
- Browser: Headless Chrome with optimized settings
- Network: Supports both HTTP and HTTPS

## Security

- Runs in isolated container environment
- No persistent storage between scans
- Secure Supabase connection with service key
- Outbound-only network access
