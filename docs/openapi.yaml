openapi: 3.0.3
info:
  title: Flawlesst API
  version: 1.0.0
  description: |
    API for connecting projects to Flawlesst and reacting to GitHub events.
servers:
  - url: https://api.example.com/prod
    description: Production API Gateway URL (replace with actual output from CDK)

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: x-api-key

  schemas:
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          example: ok
        service:
          type: string
          example: flawlesst-api
        timestamp:
          type: string
          format: date-time

    CloneRepoRequest:
      type: object
      required:
        - owner
        - repo
        - userId
        - projectId
      properties:
        owner:
          type: string
          description: GitHub owner (user or organization)
          example: surf66
        repo:
          type: string
          description: Repository name
          example: flawlesst-api
        branch:
          type: string
          description: Branch to clone
          default: main
          example: main
        githubToken:
          type: string
          description: GitHub access token used to access the repo
        userId:
          type: string
          description: User identifier
          example: user123
        projectId:
          type: string
          description: Project identifier
          example: project456
        autoStartAnalysis:
          type: boolean
          description: Whether to automatically start analysis after cloning
          default: true
          example: true

    CloneRepoResponse:
      type: object
      properties:
        executionArn:
          type: string
        startDate:
          type: string
          format: date-time
        message:
          type: string
          example: Clone and analysis started

    AnalysisRequest:
      type: object
      required:
        - userId
        - projectId
      properties:
        userId:
          type: string
          description: User identifier
          example: user123
        projectId:
          type: string
          description: Project identifier
          example: project456

    AnalysisResponse:
      type: object
      properties:
        executionArn:
          type: string
          description: Analysis step function execution ARN
        status:
          type: string
          example: STARTED
        message:
          type: string
          example: Analysis started for 150 files
        fileCount:
          type: integer
          description: Number of files being analyzed
          example: 150

    ConnectProjectRequest:
      type: object
      required:
        - owner
        - repo
        - githubToken
      properties:
        owner:
          type: string
          description: GitHub owner (user or organization)
          example: surf66
        repo:
          type: string
          description: Repository name
          example: flawlesst-api
        githubToken:
          type: string
          description: GitHub access token with permission to create webhooks on the repo

    ConnectProjectResponse:
      type: object
      properties:
        message:
          type: string
          example: Webhook registered
        owner:
          type: string
        repo:
          type: string
        webhookUrl:
          type: string
        secret:
          type: string
          description: Partial webhook secret (truncated for security)

    StartWorkflowRequest:
      type: object
      required:
        - owner
        - repo
        - userId
        - projectId
        - githubToken
      properties:
        owner:
          type: string
          description: GitHub owner (user or organization)
          example: surf66
        repo:
          type: string
          description: Repository name
          example: flawlesst-api
        branch:
          type: string
          description: Branch to clone
          default: main
          example: main
        githubToken:
          type: string
          description: GitHub access token used to access the repo
        userId:
          type: string
          description: User identifier
          example: user123
        projectId:
          type: string
          description: Project identifier
          example: project456
        autoStartAnalysis:
          type: boolean
          description: Whether to automatically start analysis after cloning
          default: true
          example: true

    StartWorkflowResponse:
      type: object
      properties:
        executionArn:
          type: string
          description: Step Functions execution ARN
        startDate:
          type: string
          format: date-time
        input:
          type: object
          description: The input that was passed to the state machine
        message:
          type: string
          description: Status message
          example: Clone, explode, and analysis workflow started

    GitHubWebhookEvent:
      type: object
      description: Raw GitHub webhook payload for push events.
      properties:
        ref:
          type: string
          example: refs/heads/main
        repository:
          type: object
          properties:
            full_name:
              type: string
              example: surf66/flawlesst-api
        sender:
          type: object
          properties:
            login:
              type: string
            type:
              type: string
        commits:
          type: array
          items:
            type: object
            properties:
              added:
                type: array
                items:
                  type: string
              modified:
                type: array
                items:
                  type: string
              removed:
                type: array
                items:
                  type: string

paths:
  /health:
    get:
      summary: Health check
      operationId: getHealth
      security:
        - ApiKeyAuth: []
      responses:
        "200":
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"

  /clone-repo:
    post:
      summary: Start repository clone and analysis workflow
      operationId: startCloneRepo
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CloneRepoRequest"
      responses:
        "202":
          description: Clone workflow started
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CloneRepoResponse"
        "400":
          description: Invalid request body
        "500":
          description: Internal error starting workflow

  /analysis:
    post:
      summary: Start analysis workflow for existing project
      description: |
        Starts the analysis step function for a project that has already been
        cloned and exploded. This allows re-running analysis without re-cloning
        the repository.
      operationId: startAnalysis
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AnalysisRequest"
      responses:
        "202":
          description: Analysis workflow started
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AnalysisResponse"
        "400":
          description: Invalid request body or no exploded files found
        "500":
          description: Internal error starting analysis workflow

  /connect-project:
    post:
      summary: Register GitHub webhook for a project
      description: |
        Registers a push webhook on the specified GitHub repository so that
        Flawlesst is notified on future pushes. This endpoint only handles
        webhook registration. Use the /start-workflow endpoint to start the
        clone and analysis process.
      operationId: connectProject
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ConnectProjectRequest"
      responses:
        "201":
          description: Webhook successfully registered
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ConnectProjectResponse"
        "400":
          description: Missing or invalid request body
        "502":
          description: Failed to register webhook with GitHub
        "500":
          description: Internal error

  /start-workflow:
    post:
      summary: Start clone and analysis workflow
      description: |
        Starts the clone/explode/analysis workflow for a project.
        This endpoint directly calls the Step Functions state machine.
        The project should have already been connected via /connect-project.
      operationId: startWorkflow
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/StartWorkflowRequest"
      responses:
        "200":
          description: Workflow started
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StartWorkflowResponse"
        "400":
          description: Invalid request body
        "500":
          description: Internal error starting workflow

  /webhooks/github:
    post:
      summary: GitHub webhook receiver
      description: |
        Public endpoint that receives GitHub webhook events.

        Security is enforced via the X-Hub-Signature-256 header using a
        shared secret derived from an internal base secret and the
        repository full name.

        Only push events on selected branches are processed, and events
        that only touch documentation or are authored by bots are
        ignored to save compute.
      operationId: githubWebhook
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/GitHubWebhookEvent"
      responses:
        "202":
          description: Event accepted or ignored after filtering
        "400":
          description: Invalid payload
        "401":
          description: Signature verification failed
        "500":
          description: Internal error
