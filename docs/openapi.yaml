openapi: 3.0.3
info:
  title: Flawlesst API
  version: 1.0.0
  description: |
    API for connecting projects to Flawlesst and reacting to GitHub events.
servers:
  - url: https://api.example.com/prod
    description: Production API Gateway URL (replace with actual output from CDK)

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: x-api-key

  schemas:
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          example: ok
        service:
          type: string
          example: flawlesst-api
        timestamp:
          type: string
          format: date-time

    CloneRepoRequest:
      type: object
      required:
        - owner
        - repo
        - userId
        - projectId
      properties:
        owner:
          type: string
          description: GitHub owner (user or organization)
          example: surf66
        repo:
          type: string
          description: Repository name
          example: flawlesst-api
        branch:
          type: string
          description: Branch to clone
          default: main
          example: main
        githubToken:
          type: string
          description: GitHub access token used to access the repo
        userId:
          type: string
          description: User identifier
          example: user123
        projectId:
          type: string
          description: Project identifier
          example: project456
        autoStartAnalysis:
          type: boolean
          description: Whether to automatically start analysis after cloning
          default: true
          example: true

    CloneRepoResponse:
      type: object
      properties:
        executionArn:
          type: string
        startDate:
          type: string
          format: date-time
        message:
          type: string
          example: Clone and analysis started

    AnalysisRequest:
      type: object
      required:
        - userId
        - projectId
      properties:
        userId:
          type: string
          description: User identifier
          example: user123
        projectId:
          type: string
          description: Project identifier
          example: project456

    AnalysisResponse:
      type: object
      properties:
        executionArn:
          type: string
          description: Analysis step function execution ARN
        status:
          type: string
          example: STARTED
        message:
          type: string
          example: Analysis started for 150 files
        fileCount:
          type: integer
          description: Number of files being analyzed
          example: 150

    ConnectProjectRequest:
      type: object
      required:
        - owner
        - repo
        - githubToken
      properties:
        owner:
          type: string
          description: GitHub owner (user or organization)
          example: surf66
        repo:
          type: string
          description: Repository name
          example: flawlesst-api
        githubToken:
          type: string
          description: GitHub access token with permission to create webhooks on the repo

    ConnectProjectResponse:
      type: object
      properties:
        message:
          type: string
          example: Webhook registered
        owner:
          type: string
        repo:
          type: string
        branch:
          type: string
        executionArn:
          type: string
          description: Step Functions execution ARN for the started workflow
        startDate:
          type: string
          format: date-time
          description: When the workflow started
        executionError:
          type: string
          description: Error message if workflow failed to start

    StartWorkflowRequest:
      type: object
      required:
        - owner
        - repo
        - userId
        - projectId
        - githubToken
      properties:
        owner:
          type: string
          description: GitHub owner (user or organization)
          example: surf66
        repo:
          type: string
          description: Repository name
          example: flawlesst-api
        branch:
          type: string
          description: Branch to clone
          default: main
          example: main
        githubToken:
          type: string
          description: GitHub access token used to access the repo
        userId:
          type: string
          description: User identifier
          example: user123
        projectId:
          type: string
          description: Project identifier
          example: project456
        autoStartAnalysis:
          type: boolean
          description: Whether to automatically start analysis after cloning
          default: true
          example: true

    StartWorkflowResponse:
      type: object
      properties:
        executionArn:
          type: string
          description: Step Functions execution ARN
        startDate:
          type: string
          format: date-time
        input:
          type: object
          description: The input that was passed to the state machine
        message:
          type: string
          description: Status message
          example: Clone, explode, and analysis workflow started

    GitHubWebhookEvent:
      type: object
      description: Raw GitHub webhook payload for push events.
      properties:
        ref:
          type: string
          example: refs/heads/main
        repository:
          type: object
          properties:
            full_name:
              type: string
              example: surf66/flawlesst-api
        sender:
          type: object
          properties:
            login:
              type: string
            type:
              type: string
        commits:
          type: array
          items:
            type: object
            properties:
              added:
                type: array
                items:
                  type: string
              modified:
                type: array
                items:
                  type: string
              removed:
                type: array
                items:
                  type: string

    ProjectSummary:
      type: object
      properties:
        project_id:
          type: string
          format: uuid
          description: Unique identifier for the project
          example: "123e4567-e89b-12d3-a456-426614174000"
        project_name:
          type: string
          description: Human-readable project name
          example: "Flawlesst API"
        report_id:
          type: string
          format: uuid
          description: Unique identifier for the analysis report
          example: "987e6543-e21b-32d1-b456-426614174999"
        overall_score:
          type: integer
          minimum: 0
          maximum: 100
          description: Overall project score (0-100)
          example: 85
        total_files:
          type: integer
          minimum: 0
          description: Total number of files analyzed
          example: 150
        files_with_tests:
          type: integer
          minimum: 0
          description: Number of files that have tests
          example: 75
        test_coverage_percentage:
          type: number
          format: float
          minimum: 0
          maximum: 100
          description: Percentage of files with test coverage
          example: 50.0
        average_score:
          type: number
          format: float
          minimum: 0
          maximum: 10
          description: Average score across all files (0-10)
          example: 8.5
        analysis_date:
          type: string
          format: date-time
          description: When the analysis was performed
          example: "2024-01-15T10:30:00Z"
        analyzed_files_count:
          type: integer
          minimum: 0
          description: Count of files that were analyzed
          example: 150
        avg_file_score:
          type: number
          format: float
          minimum: 0
          maximum: 10
          description: Average score per file
          example: 8.5

    SingleProjectResponse:
      type: object
      properties:
        project_summary:
          $ref: "#/components/schemas/ProjectSummary"
        total_reports:
          type: integer
          minimum: 1
          description: Number of reports returned (always 1 for single project)
          example: 1

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: Error type/category
          example: "No project summaries found"
        message:
          type: string
          description: Detailed error message
          example: "No analysis reports found for user 12345678-1234-1234-1234-123456789012"

    ConnectedRepository:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier for the connected repository
          example: "123e4567-e89b-12d3-a456-426614174000"
        user_id:
          type: string
          format: uuid
          description: User ID who owns this repository connection
          example: "12345678-1234-1234-1234-123456789012"
        github_repo_id:
          type: integer
          format: int64
          description: GitHub repository ID
          example: 123456789
        owner:
          type: string
          description: GitHub repository owner (user or organization)
          example: "surf66"
        repo_name:
          type: string
          description: Repository name
          example: "flawlesst-api"
        branch:
          type: string
          description: Branch that is connected
          example: "main"
        created_at:
          type: string
          format: date-time
          description: When the repository was connected
          example: "2024-01-15T10:30:00Z"
        updated_at:
          type: string
          format: date-time
          description: When the connection was last updated
          example: "2024-01-15T10:30:00Z"

    UserProjectsResponse:
      type: object
      properties:
        projects:
          type: array
          description: List of connected repositories for the user
          items:
            $ref: "#/components/schemas/ConnectedRepository"
        total_projects:
          type: integer
          minimum: 0
          description: Total number of projects for this user
          example: 5

    AccessibilityScanRequest:
      type: object
      required:
        - target_url
        - customer_id
      properties:
        target_url:
          type: string
          format: uri
          description: The URL to scan for accessibility violations
          example: "https://example.com"
        customer_id:
          type: string
          format: uuid
          description: Customer identifier for tracking and billing
          example: "123e4567-e89b-12d3-a456-426614174000"

    AccessibilityScanResponse:
      type: object
      properties:
        scan_id:
          type: string
          format: uuid
          description: Unique identifier for the accessibility scan
          example: "987e6543-e21b-32d1-b456-426614174999"
        status:
          type: string
          enum: ["started", "error"]
          description: Status of the scan request
          example: "started"
        message:
          type: string
          description: Status message describing the result
          example: "Accessibility scan started successfully"

    AccessibilityViolation:
      type: object
      description: Individual accessibility violation found by axe-core
      properties:
        id:
          type: string
          description: Rule identifier
          example: "color-contrast"
        impact:
          type: string
          enum: ["minor", "moderate", "serious", "critical"]
          description: Severity level of the violation
          example: "serious"
        tags:
          type: array
          items:
            type: string
          description: WCAG tags associated with the violation
          example: ["wcag2aa", "wcag143"]
        description:
          type: string
          description: Human-readable description of the issue
          example: "Elements must have sufficient color contrast"
        help:
          type: string
          description: Help text for fixing the issue
          example: "Elements must have sufficient color contrast"
        helpUrl:
          type: string
          format: uri
          description: URL to documentation about fixing this issue
          example: "https://dequeuniversity.com/rules/axe/4.4/color-contrast?application=axeAPI"
        nodes:
          type: array
          description: List of DOM nodes that violate this rule
          items:
            type: object
            properties:
              html:
                type: string
                description: HTML snippet of the violating element
              target:
                type: array
                items:
                  type: string
                description: CSS selectors targeting the element
              failureSummary:
                type: string
                description: Summary of why this element fails

paths:
  /health:
    get:
      summary: Health check
      operationId: getHealth
      security:
        - ApiKeyAuth: []
      responses:
        "200":
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"

  /clone-repo:
    post:
      summary: Start repository clone and analysis workflow
      operationId: startCloneRepo
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CloneRepoRequest"
      responses:
        "202":
          description: Clone workflow started
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CloneRepoResponse"
        "400":
          description: Invalid request body
        "500":
          description: Internal error starting workflow

  /analysis:
    post:
      summary: Start analysis workflow for existing project
      description: |
        Starts the analysis step function for a project that has already been
        cloned and exploded. This allows re-running analysis without re-cloning
        the repository.
      operationId: startAnalysis
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AnalysisRequest"
      responses:
        "202":
          description: Analysis workflow started
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AnalysisResponse"
        "400":
          description: Invalid request body or no exploded files found
        "500":
          description: Internal error starting analysis workflow

  /connect-project:
    post:
      summary: Register GitHub webhook and start workflow
      description: |
        Registers a push webhook on the specified GitHub repository so that
        Flawlesst is notified on future pushes, and automatically starts the
        clone/explode/analysis workflow for the initial repository analysis.
      operationId: connectProject
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ConnectProjectRequest"
      responses:
        "201":
          description: Webhook registered and workflow started
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ConnectProjectResponse"
        "400":
          description: Missing or invalid request body
        "502":
          description: Failed to register webhook with GitHub
        "500":
          description: Internal error

  /start-workflow:
    post:
      summary: Start clone and analysis workflow
      description: |
        Starts the clone/explode/analysis workflow for a project.
        This endpoint directly calls the Step Functions state machine.
        The project should have already been connected via /connect-project.
      operationId: startWorkflow
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/StartWorkflowRequest"
      responses:
        "200":
          description: Workflow started
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StartWorkflowResponse"
        "400":
          description: Invalid request body
        "500":
          description: Internal error starting workflow

  /webhooks/github:
    post:
      summary: GitHub webhook receiver
      description: |
        Public endpoint that receives GitHub webhook events.

        Security is enforced via the X-Hub-Signature-256 header using a
        shared secret derived from an internal base secret and the
        repository full name.

        Only push events on selected branches are processed, and events
        that only touch documentation or are authored by bots are
        ignored to save compute.
      operationId: githubWebhook
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/GitHubWebhookEvent"
      responses:
        "202":
          description: Event accepted or ignored after filtering
        "400":
          description: Invalid payload
        "401":
          description: Signature verification failed
        "500":
          description: Internal error

  /project-analysis-summary/{projectId}:
    get:
      summary: Get project analysis summary
      description: |
        Retrieves the most recent analysis summary for a specific project.
        Returns detailed metrics for the requested project only.
      operationId: getProjectAnalysisSummary
      security:
        - ApiKeyAuth: []
      parameters:
        - name: projectId
          in: path
          required: true
          description: Specific project ID to retrieve summary for
          schema:
            type: string
            format: uuid
          example: "87654321-4321-4321-4321-210987654321"
        - name: userId
          in: query
          required: true
          description: User ID to verify ownership of the project
          schema:
            type: string
            format: uuid
          example: "12345678-1234-1234-1234-123456789012"
      responses:
        "200":
          description: Project summary retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SingleProjectResponse"
        "400":
          description: Missing required parameter
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                missingUserId:
                  summary: Missing userId parameter
                  value:
                    error: "Missing required parameter: userId"
                    message: "userId must be provided as a query parameter"
                missingProjectId:
                  summary: Missing projectId parameter
                  value:
                    error: "Missing required parameter: projectId"
                    message: "projectId must be provided as a path parameter"
        "404":
          description: Project analysis summary not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                noProject:
                  summary: No specific project found
                  value:
                    error: "Project analysis summary not found"
                    message: "No analysis reports found for project 87654321-4321-4321-4321-210987654321 and user 12345678-1234-1234-1234-123456789012"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /get-user-projects:
    get:
      summary: Get all projects for a user
      description: |
        Retrieves all connected repositories (projects) for a specific user from the 
        connected_repositories table. Results are ordered by creation date (newest first).
      operationId: getUserProjects
      security:
        - ApiKeyAuth: []
      parameters:
        - name: userId
          in: query
          required: true
          description: User ID to retrieve projects for
          schema:
            type: string
            format: uuid
          example: "12345678-1234-1234-1234-123456789012"
      responses:
        "200":
          description: User projects retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserProjectsResponse"
              examples:
                success:
                  summary: Successful response with projects
                  value:
                    projects:
                      - id: "123e4567-e89b-12d3-a456-426614174000"
                        user_id: "12345678-1234-1234-1234-123456789012"
                        github_repo_id: 123456789
                        owner: "surf66"
                        repo_name: "flawlesst-api"
                        branch: "main"
                        created_at: "2024-01-15T10:30:00Z"
                        updated_at: "2024-01-15T10:30:00Z"
                      - id: "987e6543-e21b-32d1-b456-426614174999"
                        user_id: "12345678-1234-1234-1234-123456789012"
                        github_repo_id: 987654321
                        owner: "surf66"
                        repo_name: "another-repo"
                        branch: "develop"
                        created_at: "2024-01-10T15:45:00Z"
                        updated_at: "2024-01-10T15:45:00Z"
                    total_projects: 2
                noProjects:
                  summary: User has no projects
                  value:
                    projects: []
                    total_projects: 0
        "400":
          description: Missing required parameter
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                missingUserId:
                  summary: Missing userId parameter
                  value:
                    error: "Missing required parameter: userId"
                    message: "userId must be provided as a query parameter"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /accessibility-scan:
    post:
      summary: Start accessibility scan
      description: |
        Starts an accessibility scan using Playwright and axe-core for the specified URL.
        The scan runs in an ephemeral AWS Fargate container and results are stored in Supabase.
        This endpoint returns immediately with a scan_id that can be used to track progress.
        
        The scanning process:
        1. Creates a scan record in Supabase with 'pending' status
        2. Starts a Fargate task with Playwright and axe-core
        3. The container scans the target URL for accessibility violations
        4. Results are stored in Supabase with detailed violation information
        5. Status is updated to 'completed' or 'failed'
        
        Scan results include WCAG violations, impact levels, and specific DOM elements
        that need attention.
      operationId: triggerAccessibilityScan
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AccessibilityScanRequest"
            examples:
              validRequest:
                summary: Valid accessibility scan request
                value:
                  target_url: "https://example.com"
                  customer_id: "123e4567-e89b-12d3-a456-426614174000"
      responses:
        "202":
          description: Accessibility scan started successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AccessibilityScanResponse"
              examples:
                scanStarted:
                  summary: Scan initiated successfully
                  value:
                    scan_id: "987e6543-e21b-32d1-b456-426614174999"
                    status: "started"
                    message: "Accessibility scan started successfully"
        "400":
          description: Invalid request body
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                missingFields:
                  summary: Missing required fields
                  value:
                    error: "Missing required fields: target_url and customer_id"
                    message: "Both target_url and customer_id must be provided"
                invalidUrl:
                  summary: Invalid URL format
                  value:
                    error: "Invalid target_url format"
                    message: "target_url must be a valid URL"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
